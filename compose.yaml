services:
  # DynamoDB Local(起動)
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    ports:
      - "9000:8000"
    volumes:
      - ./docker/dynamodb:/home/dynamodblocal/data
    working_dir: /home/dynamodblocal

  # DynamoDB Local(テーブル作成)
  dynamodb-local-create-table:
    image: node:22-slim
    container_name: dynamodb-local-create-table
    command: sh -c "cd /scripts && npm install @aws-sdk/client-dynamodb && node create_table.js"
    volumes:
      - ./docker/scripts:/scripts
    depends_on:
      - dynamodb-local
    restart: "no"

  # [POST] /memo
  create-memo:
    image: public.ecr.aws/lambda/nodejs:22
    command: ["index.handler"]
    restart: always
    volumes:
      - ./lambdas/create_memo:/var/task
      - ./lambdas/layer/nodejs:/opt/nodejs
    ports:
      - "9001:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [GET] /memo
  list-memos:
    image: public.ecr.aws/lambda/nodejs:22
    command: ["index.handler"]
    restart: always
    volumes:
      - ./lambdas/list_memos:/var/task
      - ./lambdas/layer/nodejs:/opt/nodejs
    ports:
      - "9002:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [GET] /memo/{memoId}
  get-memo:
    image: public.ecr.aws/lambda/nodejs:22
    command: ["index.handler"]
    restart: always
    volumes:
      - ./lambdas/get_memo:/var/task
      - ./lambdas/layer/nodejs:/opt/nodejs
    ports:
      - "9003:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [PUT] /memo/{memoId}
  update-memo:
    image: public.ecr.aws/lambda/nodejs:22
    command: ["index.handler"]
    restart: always
    volumes:
      - ./lambdas/update_memo:/var/task
      - ./lambdas/layer/nodejs:/opt/nodejs
    ports:
      - "9004:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [DELETE] /memo/{memoId}
  delete-memo:
    image: public.ecr.aws/lambda/nodejs:22
    command: ["index.handler"]
    restart: always
    volumes:
      - ./lambdas/delete_memo:/var/task
      - ./lambdas/layer/nodejs:/opt/nodejs
    ports:
      - "9005:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully
