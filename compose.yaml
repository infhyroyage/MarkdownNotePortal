services:
  # DynamoDB Local(起動)
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: dynamodb-local
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath ./data"
    ports:
      - "9000:8000"
    volumes:
      - ./docker/dynamodb:/home/dynamodblocal/data
    working_dir: /home/dynamodblocal

  # DynamoDB Local(テーブル作成)
  dynamodb-local-create-table:
    image: python:3.12-slim
    container_name: dynamodb-local-create-table
    command: sh -c "pip install -q boto3 && python /scripts/create_table.py"
    volumes:
      - ./docker/scripts:/scripts
    depends_on:
      - dynamodb-local
    restart: "no"

  # [POST] /memo
  create-memo:
    image: public.ecr.aws/lambda/python:3.12
    command: ["app.lambda_handler"]
    restart: always
    volumes:
      - ./lambdas/create_memo:/var/task
      - ./lambdas/layer/python:/opt/python
    ports:
      - "9001:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - TABLE_NAME=mkmemoportal-dynamodb
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [GET] /memo
  list-memos:
    image: public.ecr.aws/lambda/python:3.12
    command: ["app.lambda_handler"]
    restart: always
    volumes:
      - ./lambdas/list_memos:/var/task
      - ./lambdas/layer/python:/opt/python
    ports:
      - "9002:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - TABLE_NAME=mkmemoportal-dynamodb
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [GET] /memo/{memoId}
  get-memo:
    image: public.ecr.aws/lambda/python:3.12
    command: ["app.lambda_handler"]
    restart: always
    volumes:
      - ./lambdas/get_memo:/var/task
      - ./lambdas/layer/python:/opt/python
    ports:
      - "9003:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - TABLE_NAME=mkmemoportal-dynamodb
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [PUT] /memo/{memoId}
  update-memo:
    image: public.ecr.aws/lambda/python:3.12
    command: ["app.lambda_handler"]
    restart: always
    volumes:
      - ./lambdas/update_memo:/var/task
      - ./lambdas/layer/python:/opt/python
    ports:
      - "9004:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - TABLE_NAME=mkmemoportal-dynamodb
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully

  # [DELETE] /memo/{memoId}
  delete-memo:
    image: public.ecr.aws/lambda/python:3.12
    command: ["app.lambda_handler"]
    restart: always
    volumes:
      - ./lambdas/delete_memo:/var/task
      - ./lambdas/layer/python:/opt/python
    ports:
      - "9005:8080"
    environment:
      - DYNAMODB_ENDPOINT=http://dynamodb-local:8000
      - TABLE_NAME=mkmemoportal-dynamodb
      - IS_LOCAL=true
    depends_on:
      dynamodb-local-create-table:
        condition: service_completed_successfully
