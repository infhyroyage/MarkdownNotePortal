name: Deploy Lambda Functions (Reusable Workflow)

on:
  workflow_call:
    inputs:
      S3_LAMBDA_BUCKET_NAME:
        required: true
        type: string
      S3_LAMBDA_EDGE_BUCKET_NAME:
        required: true
        type: string
    secrets:
      AWS_ARN_IAM_ROLE_GITHUB_ACTIONS:
        required: true

permissions:
  id-token: write # Required for requesting the OIDC JWT
  contents: read # Required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}
          aws-region: ap-northeast-1

      - name: Update Lambda Functions Code
        run: |
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-create-memo \
            --s3-bucket ${{ inputs.S3_LAMBDA_BUCKET_NAME }} \
            --s3-key create_memo.zip \
            --region ap-northeast-1
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-delete-memo \
            --s3-bucket ${{ inputs.S3_LAMBDA_BUCKET_NAME }} \
            --s3-key delete_memo.zip \
            --region ap-northeast-1
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-get-memo \
            --s3-bucket ${{ inputs.S3_LAMBDA_BUCKET_NAME }} \
            --s3-key get_memo.zip \
            --region ap-northeast-1
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-list-memos \
            --s3-bucket ${{ inputs.S3_LAMBDA_BUCKET_NAME }} \
            --s3-key list_memos.zip \
            --region ap-northeast-1
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-update-memo \
            --s3-bucket ${{ inputs.S3_LAMBDA_BUCKET_NAME }} \
            --s3-key update_memo.zip \
            --region ap-northeast-1

      - name: Update Lambda Layer
        run: |
          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name mkmemoportal-lambda-layer \
            --content S3Bucket=${{ inputs.S3_LAMBDA_BUCKET_NAME }},S3Key=layer.zip \
            --compatible-runtimes nodejs22.x \
            --region ap-northeast-1 \
            --query 'Version' \
            --output text)
          LAYER_ARN="arn:aws:lambda:ap-northeast-1:$(aws sts get-caller-identity --query Account --output text):layer:mkmemoportal-lambda-layer:$LAYER_VERSION"
          aws lambda update-function-configuration \
            --function-name mkmemoportal-lambda-create-memo \
            --layers $LAYER_ARN \
            --region ap-northeast-1
          aws lambda update-function-configuration \
            --function-name mkmemoportal-lambda-delete-memo \
            --layers $LAYER_ARN \
            --region ap-northeast-1
          aws lambda update-function-configuration \
            --function-name mkmemoportal-lambda-get-memo \
            --layers $LAYER_ARN \
            --region ap-northeast-1
          aws lambda update-function-configuration \
            --function-name mkmemoportal-lambda-list-memos \
            --layers $LAYER_ARN \
            --region ap-northeast-1
          aws lambda update-function-configuration \
            --function-name mkmemoportal-lambda-update-memo \
            --layers $LAYER_ARN \
            --region ap-northeast-1

      - name: Update Lambda@Edge Function Code
        run: |
          aws lambda update-function-code \
            --function-name mkmemoportal-lambda-edge-viewer-request \
            --s3-bucket ${{ inputs.S3_LAMBDA_EDGE_BUCKET_NAME }} \
            --s3-key edge_viewer_request.zip \
            --region us-east-1
          aws lambda wait function-updated \
            --function-name mkmemoportal-lambda-edge-viewer-request \
            --region us-east-1

      - name: Publish New Lambda@Edge Version
        id: publish_lambda_edge
        run: |
          NEW_VERSION_ARN=$(aws lambda publish-version \
            --function-name mkmemoportal-lambda-edge-viewer-request \
            --region us-east-1 \
            --query 'FunctionArn' \
            --output text)
          echo "new_version_arn=$NEW_VERSION_ARN" >> $GITHUB_OUTPUT

      - name: Get CloudFront Distribution ID
        id: get_cloudfront_id
        run: |
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name mkmemoportal-stack-ap-northeast-1 \
            --region ap-northeast-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)
          echo "distribution_id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT

      - name: Update CloudFront Distribution
        env:
          DISTRIBUTION_ID: ${{ steps.get_cloudfront_id.outputs.distribution_id }}
          NEW_VERSION_ARN: ${{ steps.publish_lambda_edge.outputs.new_version_arn }}
        run: |
          DISTRIBUTION_CONFIG=$(aws cloudfront get-distribution-config \
            --id "$DISTRIBUTION_ID" \
            --output json)
          ETAG=$(echo "$DISTRIBUTION_CONFIG" | jq -r '.ETag')
          UPDATED_DISTRIBUTION_CONFIG=$(echo "$DISTRIBUTION_CONFIG" | jq --arg ARN "$NEW_VERSION_ARN" \
            '.DistributionConfig.DefaultCacheBehavior.LambdaFunctionAssociations.Items[0].LambdaFunctionARN = $ARN | .DistributionConfig')
          aws cloudfront update-distribution \
            --id "$DISTRIBUTION_ID" \
            --distribution-config "$UPDATED_DISTRIBUTION_CONFIG" \
            --if-match "$ETAG"
