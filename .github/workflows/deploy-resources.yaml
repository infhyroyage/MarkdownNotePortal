name: Deploy All AWS Resources

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/deploy-resources.yaml
      - resources/**

permissions:
  id-token: write # Required for requesting the OIDC JWT
  contents: read # Required for actions/checkout

jobs:
  build-lambdas:
    uses: ./.github/workflows/reusable-build-lambdas.yaml
    with:
      S3_LAMBDA_BUCKET_NAME: ${{ vars.S3_LAMBDA_BUCKET_NAME }}
      S3_LAMBDA_EDGE_BUCKET_NAME: ${{ vars.S3_LAMBDA_EDGE_BUCKET_NAME }}
    secrets:
      AWS_ARN_IAM_ROLE_GITHUB_ACTIONS: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}

  deploy-stack-waf:
    needs: build-lambdas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS Credentials for us-east-1
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}
          aws-region: us-east-1

      - name: Deploy Stack in us-east-1
        run: |
          aws cloudformation deploy \
            --template-file resources/cfn_us-east-1.yaml \
            --stack-name mkmemoportal-stack-us-east-1 \
            --region us-east-1 \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              S3LambdaEdgeBucketName=${{ vars.S3_LAMBDA_EDGE_BUCKET_NAME }}

      - name: Describe Stack Events on Failure
        if: failure()
        run: |
          echo "=== CloudFormation Stack Events in us-east-1 (Recent) ==="
          aws cloudformation describe-stack-events \
            --stack-name mkmemoportal-stack-us-east-1 \
            --region us-east-1 \
            --max-items 50 \
            --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED` || ResourceStatus==`DELETE_FAILED` || ResourceStatus==`ROLLBACK_IN_PROGRESS`].[Timestamp,ResourceType,LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
            --output table || true

  deploy-stack:
    needs:
      - build-lambdas
      - deploy-stack-waf
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}
          aws-region: ap-northeast-1

      - name: Deploy Stack in ap-northeast-1
        run: |
          WAF_WEB_ACL_ARN=$(aws cloudformation describe-stacks \
            --stack-name mkmemoportal-stack-us-east-1 \
            --region us-east-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`WafWebAclArn`].OutputValue' \
            --output text)
          LAMBDA_EDGE_VERSION_ARN=$(aws cloudformation describe-stacks \
            --stack-name mkmemoportal-stack-us-east-1 \
            --region us-east-1 \
            --query 'Stacks[0].Outputs[?OutputKey==`LambdaEdgeViewerRequestVersionArn`].OutputValue' \
            --output text)
          aws cloudformation deploy \
            --template-file resources/cfn_ap-northeast-1.yaml \
            --stack-name mkmemoportal-stack-ap-northeast-1 \
            --region ap-northeast-1 \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              CognitoHostedUISubDomain=${{ vars.COGNITO_HOSTED_UI_SUBDOMAIN }} \
              S3LambdaBucketName=${{ vars.S3_LAMBDA_BUCKET_NAME }} \
              S3SpaBucketName=${{ vars.S3_SPA_BUCKET_NAME }} \
              WafWebAclArn=${WAF_WEB_ACL_ARN} \
              LambdaEdgeViewerRequestVersionArn=${LAMBDA_EDGE_VERSION_ARN}

      - name: Describe Stack Events on Failure (ap-northeast-1)
        if: failure()
        run: |
          echo "=== CloudFormation Stack Events in ap-northeast-1 (Recent) ==="
          aws cloudformation describe-stack-events \
            --stack-name mkmemoportal-stack-ap-northeast-1 \
            --region ap-northeast-1 \
            --max-items 50 \
            --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED` || ResourceStatus==`DELETE_FAILED` || ResourceStatus==`ROLLBACK_IN_PROGRESS`].[Timestamp,ResourceType,LogicalResourceId,ResourceStatus,ResourceStatusReason]' \
            --output table || true

  deploy-lambdas:
    needs: deploy-stack
    uses: ./.github/workflows/reusable-deploy-lambdas.yaml
    with:
      S3_LAMBDA_BUCKET_NAME: ${{ vars.S3_LAMBDA_BUCKET_NAME }}
      S3_LAMBDA_EDGE_BUCKET_NAME: ${{ vars.S3_LAMBDA_EDGE_BUCKET_NAME }}
    secrets:
      AWS_ARN_IAM_ROLE_GITHUB_ACTIONS: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}

  build-and-deploy-spa:
    needs: deploy-stack
    uses: ./.github/workflows/reusable-build-and-deploy-spa.yaml
    with:
      S3_SPA_BUCKET_NAME: ${{ vars.S3_SPA_BUCKET_NAME }}
    secrets:
      AWS_ARN_IAM_ROLE_GITHUB_ACTIONS: ${{ secrets.AWS_ARN_IAM_ROLE_GITHUB_ACTIONS }}
